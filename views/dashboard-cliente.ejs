<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Dashboard - Hotel Flamingo</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-page">
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üè®</div>
                <h3>Hotel Flamingo</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="sidebar-link active">
                    <span>üè†</span> Dashboard
                </a>
                <a href="/habitaciones" class="sidebar-link">
                    <span>üõèÔ∏è</span> Habitaciones
                </a>
                <a href="/dashboard#mis-reservas" class="sidebar-link">
                    <span>üìÖ</span> Mis Reservas
                </a>
                <a href="/logout" class="sidebar-link">
                    <span>üö™</span> Cerrar Sesi√≥n
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">üë§</div>
                    <div class="user-details">
                        <p class="user-name"><%= user.nombre_completo %></p>
                        <p class="user-role">Cliente</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <div class="dashboard-header">
                <h1>Bienvenido, <%= user.nombre_completo %></h1>
                <p class="text-muted">Gestiona tus reservas y explora nuestras habitaciones</p>
            </div>

            <% if (typeof success !== 'undefined' && success) { %>
                <div class="alert alert-success">
                    <%= success %>
                </div>
            <% } %>

            <% if (typeof error !== 'undefined' && error) { %>
                <div class="alert alert-error">
                    <%= error %>
                </div>
            <% } %>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-content">
                        <h3><%= reservas.filter(r => r.estado === 'confirmada' || r.estado === 'pendiente').length %></h3>
                        <p>Reservas Activas</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3><%= reservas.filter(r => r.estado === 'completada').length %></h3>
                        <p>Completadas</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üõèÔ∏è</div>
                    <div class="stat-content">
                        <h3><%= habitaciones.length %></h3>
                        <p>Habitaciones Disponibles</p>
                    </div>
                </div>
            </div>

            <!-- Mis Reservas -->
            <section id="mis-reservas" class="dashboard-section">
                <div class="section-header">
                    <h2>Mis Reservas</h2>
                </div>
                
                <% if (reservas.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <h3>No tienes reservas</h3>
                        <p>Explora nuestras habitaciones y haz tu primera reserva</p>
                        <a href="/habitaciones" class="btn btn-primary">Ver Habitaciones</a>
                    </div>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Habitaci√≥n</th>
                                    <th>Tipo</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% reservas.forEach(reserva => { %>
                                    <tr>
                                        <td><strong>#<%= reserva.numero_habitacion %></strong></td>
                                        <td><%= reserva.tipo_habitacion %></td>
                                        <td><%= new Date(reserva.fecha_entrada).toLocaleDateString('es-ES') %></td>
                                        <td><%= new Date(reserva.fecha_salida).toLocaleDateString('es-ES') %></td>
                                        <td><strong>$<%= reserva.costo_total.toLocaleString() %></strong></td>
                                        <td>
                                            <span class="badge badge-<%= reserva.estado %>">
                                                <%= reserva.estado.charAt(0).toUpperCase() + reserva.estado.slice(1) %>
                                            </span>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </section>

            <!-- Habitaciones Disponibles -->
            <section class="dashboard-section">
                <div class="section-header">
                    <h2>Habitaciones Disponibles</h2>
                    <a href="/habitaciones" class="btn btn-outline">Ver Todas</a>
                </div>
                
                <div class="rooms-grid">
                    <% habitaciones.slice(0, 6).forEach(habitacion => { %>
                        <div class="room-card">
                            <div class="room-image">
                                <% if (habitacion.imagen_url) { %>
                                    <img src="<%= habitacion.imagen_url %>" alt="<%= habitacion.tipo %>">
                                <% } else { %>
                                    <div class="room-placeholder">üè®</div>
                                <% } %>
                                <span class="room-type-badge"><%= habitacion.tipo %></span>
                            </div>
                            <div class="room-content">
                                <h3>Habitaci√≥n #<%= habitacion.numero %></h3>
                                <div class="room-info">
                                    <span>üë• Capacidad: <%= habitacion.capacidad %></span>
                                </div>
                                <% if (habitacion.descripcion) { %>
                                    <p class="room-description"><%= habitacion.descripcion %></p>
                                <% } %>
                                <div class="room-footer">
                                    <div class="room-price">
                                        <span class="price-amount">$<%= habitacion.precio_noche.toLocaleString() %></span>
                                        <span class="price-period">/noche</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm btn-reservar" 
                                            data-id="<%= habitacion.id %>" 
                                            data-tipo="<%= habitacion.tipo %>" 
                                            data-precio="<%= habitacion.precio_noche %>">
                                        Reservar
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal de Reserva -->
    <div id="reservaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Hacer Reserva</h2>
                <button onclick="closeReservaModal()" class="modal-close">&times;</button>
            </div>
            <form action="/reservar" method="POST" id="reservaForm">
                <input type="hidden" name="id_habitacion" id="modal_id_habitacion">
                
                <div class="modal-body">
                    <p id="modal_habitacion_info" class="mb-3"></p>
                    
                    <div class="form-group">
                        <label for="fecha_entrada">Fecha de Entrada</label>
                        <input type="date" name="fecha_entrada" id="fecha_entrada" required min="<%= new Date().toISOString().split('T')[0] %>">
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_salida">Fecha de Salida</label>
                        <input type="date" name="fecha_salida" id="fecha_salida" required min="<%= new Date().toISOString().split('T')[0] %>">
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Total estimado:</strong> <span id="total_estimado">$0</span>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" onclick="closeReservaModal()" class="btn btn-outline">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar Reserva</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let precioNoche = 0;

        function openReservaModal(idHabitacion, tipo, precio) {
            precioNoche = precio;
            document.getElementById('modal_id_habitacion').value = idHabitacion;
            document.getElementById('modal_habitacion_info').textContent = `${tipo} - $${precio.toLocaleString()}/noche`;
            document.getElementById('reservaModal').style.display = 'flex';
        }

        function closeReservaModal() {
            document.getElementById('reservaModal').style.display = 'none';
            document.getElementById('reservaForm').reset();
        }

        // Event delegation for Reservar buttons
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('btn-reservar')) {
                const id = parseInt(e.target.dataset.id);
                const tipo = e.target.dataset.tipo;
                const precio = parseFloat(e.target.dataset.precio);
                openReservaModal(id, tipo, precio);
            }
        });

        // Calcular total autom√°ticamente
        document.getElementById('fecha_entrada')?.addEventListener('change', calcularTotal);
        document.getElementById('fecha_salida')?.addEventListener('change', calcularTotal);

        function calcularTotal() {
            const inicio = new Date(document.getElementById('fecha_entrada').value);
            const fin = new Date(document.getElementById('fecha_salida').value);
            
            if (inicio && fin && fin > inicio) {
                const dias = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24));
                const total = dias * precioNoche;
                document.getElementById('total_estimado').textContent = `$${total.toLocaleString()} (${dias} ${dias === 1 ? 'noche' : 'noches'})`;
            } else {
                document.getElementById('total_estimado').textContent = '$0';
            }
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('reservaModal');
            if (event.target === modal) {
                closeReservaModal();
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/styles.css">
    <title>Mi Dashboard - Hotel Flamingo</title>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>üè® Hotel Flamingo</h2>
            <ul class="sidebar-menu">
                <li><a href="#" class="menu-link active" data-tab="reservas">üìÖ Mis Reservas</a></li>
                <li><a href="#" class="menu-link" data-tab="habitaciones">üõèÔ∏è Reservar Habitaci√≥n</a></li>
                <li><a href="#" class="menu-link" data-tab="perfil">üë§ Mi Perfil</a></li>
                <li style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <a href="/logout" style="background: rgba(255,255,255,0.1);">üö™ Cerrar Sesi√≥n</a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header-top">
                <div>
                    <h1>Bienvenido, <%= user.nombre %>!</h1>
                    <p style="color: var(--muted-text); margin: 0;">Manage your reservations and bookings</p>
                </div>
                <div class="user-info">
                    <p><strong><%= user.email %></strong></p>
                    <p style="color: var(--success); font-weight: 600;">‚úì Cliente Verificado</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="reservas">üìÖ Mis Reservas</button>
                <button class="tab-btn" data-tab="habitaciones">üõèÔ∏è Reservar Habitaci√≥n</button>
                <button class="tab-btn" data-tab="perfil">üë§ Mi Perfil</button>
            </div>

            <!-- Tab: Mis Reservas -->
            <div id="reservas-content" class="tab-content active">
                <h2>Mis Reservas</h2>
                <% if (reservas && reservas.length > 0) { %>
                    <div class="reservation-table table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Habitaci√≥n</th>
                                    <th>Tipo</th>
                                    <th>Check-in</th>
                                    <th>Check-out</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% reservas.forEach(reserva => { %>
                                    <tr>
                                        <td><strong><%= reserva.numero %></strong></td>
                                        <td><%= reserva.tipo %></td>
                                        <td><%= new Date(reserva.fecha_inicio).toLocaleDateString('es-ES') %></td>
                                        <td><%= new Date(reserva.fecha_fin).toLocaleDateString('es-ES') %></td>
                                        <td><strong>$<%= parseFloat(reserva.total).toFixed(2) %></strong></td>
                                        <td>
                                            <span class="status-badge status-<%= reserva.estado %>">
                                                <%= reserva.estado.toUpperCase() %>
                                            </span>
                                        </td>
                                        <td>
                                            <% if (['pendiente', 'confirmada'].includes((reserva.estado || '').toLowerCase().trim())) { %>
                                                <button class="btn-sm btn-warning" onclick="cancelarReserva('<%= reserva.id_reserva %>')">
                                                    Cancelar
                                                </button>
                                                <% if ((reserva.estado || '').toLowerCase().trim() === 'pendiente') { %>
                                                    <button class="btn-sm btn-primary" onclick="openEditMyReservation('<%= reserva.id_reserva %>', '<%= reserva.id_habitacion %>', '<%= reserva.fecha_inicio %>', '<%= reserva.fecha_fin %>')">
                                                        Editar
                                                    </button>
                                                <% } %>
                                            <% } else if (['cancelada', 'finalizada'].includes((reserva.estado || '').toLowerCase().trim())) { %>
                                                <button class="btn-sm btn-danger" onclick="eliminarReserva('<%= reserva.id_reserva %>')">
                                                    Eliminar
                                                </button>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="card" style="text-align: center; padding: 40px;">
                        <p style="color: var(--muted-text); font-size: 1.1rem; margin: 0;">
                            No tienes reservas a√∫n. ¬°Reserva una habitaci√≥n ahora!
                        </p>
                    </div>
                <% } %>
            </div>

            <!-- Tab: Reservar Habitaci√≥n -->
            <div id="habitaciones-content" class="tab-content">
                <h2>Habitaciones Disponibles</h2>
                <% if (habitaciones && habitaciones.length > 0) { %>
                    <div class="card-grid">
                        <% habitaciones.forEach(habitacion => { %>
                            <div class="room-card">
                                <div class="room-image">üõèÔ∏è</div>
                                <div class="room-info">
                                    <h3><%= habitacion.numero %></h3>
                                    <div class="room-type"><%= habitacion.tipo %></div>
                                    <div class="room-features">
                                        üìù <%= habitacion.descripcion || 'Habitaci√≥n confortable' %>
                                    </div>
                                    <div class="room-price">$<%= parseFloat(habitacion.precio).toFixed(2) %>/noche</div>
                                    <button class="btn-reserve" onclick="openReservationModal('<%= habitacion.id_habitacion %>')">
                                        Reservar Ahora
                                    </button>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } else { %>
                    <div class="card" style="text-align: center; padding: 40px;">
                        <p style="color: var(--muted-text); font-size: 1.1rem; margin: 0;">
                            No hay habitaciones disponibles en este momento.
                        </p>
                    </div>
                <% } %>
            </div>

            <!-- Tab: Perfil -->
            <div id="perfil-content" class="tab-content">
                <h2>Mi Perfil</h2>
                <div class="card" style="max-width: 600px;">
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                        <label class="label">Nombre</label>
                        <input type="text" class="input" value="<%= user.nombre %>" disabled>
                    </div>
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                        <label class="label">Email</label>
                        <input type="email" class="input" value="<%= user.email %>" disabled>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label class="label">Tipo de Cuenta</label>
                        <input type="text" class="input" value="<%= user.rol === 'admin' ? 'Administrador' : 'Cliente' %>" disabled>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Reserva -->
    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeReservationModal()">‚úï</button>
            <h2>Nueva Reserva</h2>
            <form id="reservationForm" onsubmit="submitReservation(event)">
                <div style="margin-bottom: 15px;">
                    <label for="checkIn" class="label">Fecha de Check-in</label>
                    <input type="date" id="checkIn" class="input" required>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="checkOut" class="label">Fecha de Check-out</label>
                    <input type="date" id="checkOut" class="input" required>
                </div>
                <div id="reservationMessage" style="margin-bottom: 15px;"></div>
                <button type="submit" class="btn btn-primary">Confirmar Reserva</button>
            </form>
        </div>
    </div>

    <!-- Modal Editar Reserva (Cliente) -->
    <div id="editMyReservationModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEditMyReservation()">‚úï</button>
            <h2>Editar Reserva</h2>
            <form id="editMyReservationForm" onsubmit="submitEditMyReservation(event)">
                <input type="hidden" id="my-edit-res-id">
                <div style="margin-bottom: 15px;">
                    <label for="my-edit-habitacion" class="label">Habitaci√≥n</label>
                    <select id="my-edit-habitacion" class="input" required>
                        <% habitaciones.forEach(h => { %>
                            <option value="<%= h.id_habitacion %>"><%= h.numero %> - <%= h.tipo %> ($<%= parseFloat(h.precio).toFixed(2) %>)</option>
                        <% }) %>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="my-edit-checkIn" class="label">Fecha de Check-in</label>
                    <input type="date" id="my-edit-checkIn" class="input" required>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="my-edit-checkOut" class="label">Fecha de Check-out</label>
                    <input type="date" id="my-edit-checkOut" class="input" required>
                </div>
                <div id="my-edit-res-message" style="margin-bottom: 15px;"></div>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <script>
        let currentRoomId = null;

        // Tab switching
        document.querySelectorAll('.tab-btn, .menu-link').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const tab = btn.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelectorAll('.tab-btn, .menu-link').forEach(b => b.classList.remove('active'));
                
                document.getElementById(tab + '-content').classList.add('active');
                btn.classList.add('active');
            });
        });

        // Reservation modal
        function openReservationModal(roomId) {
            currentRoomId = roomId;
            document.getElementById('reservationModal').classList.add('active');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('checkIn').min = today;
        }

        function closeReservationModal() {
            document.getElementById('reservationModal').classList.remove('active');
            document.getElementById('reservationForm').reset();
            document.getElementById('reservationMessage').innerHTML = '';
        }

        // Update checkout min date
        document.getElementById('checkIn').addEventListener('change', function() {
            const nextDay = new Date(this.value);
            nextDay.setDate(nextDay.getDate() + 1);
            document.getElementById('checkOut').min = nextDay.toISOString().split('T')[0];
        });

        async function submitReservation(e) {
            e.preventDefault();
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;
            const messageDiv = document.getElementById('reservationMessage');

            try {
                // Check availability
                const availResponse = await fetch('/api/check-disponibilidad', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_habitacion: currentRoomId,
                        fecha_inicio: checkIn,
                        fecha_fin: checkOut
                    })
                });

                const availData = await availResponse.json();

                if (!availData.disponible) {
                    messageDiv.innerHTML = '<div class="error">‚ùå Esta habitaci√≥n no est√° disponible para esas fechas</div>';
                    return;
                }

                // Submit reservation
                const response = await fetch('/reservar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_habitacion: currentRoomId,
                        fecha_inicio: checkIn,
                        fecha_fin: checkOut
                    })
                });

                const data = await response.json();

                if (data.success) {
                    messageDiv.innerHTML = '<div class="success">‚úì Reserva creada exitosamente</div>';
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    messageDiv.innerHTML = '<div class="error">‚ùå ' + data.error + '</div>';
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">‚ùå Error al procesar la reserva</div>';
            }
        }

        // Set today as min date for check-in
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checkIn').min = today;

        async function cancelarReserva(id) {
            if (!confirm('¬øEst√°s seguro de que deseas cancelar esta reserva?')) return;

            try {
                const response = await fetch(`/cancelar/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Reserva cancelada correctamente');
                    window.location.reload();
                } else {
                    alert(data.error || 'Error al cancelar');
                }
            } catch (error) {
                console.error(error);
                alert('Error al cancelar la reserva');
            }
        }

        async function eliminarReserva(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta reserva de tu historial?')) return;

            try {
                const response = await fetch(`/reservas/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Reserva eliminada correctamente');
                    window.location.reload();
                } else {
                    alert(data.error || 'Error al eliminar');
                }
            } catch (error) {
                console.error(error);
                alert('Error al eliminar la reserva');
            }
        }

        // Edit my reservation (cliente)
        function openEditMyReservation(id, id_habitacion, fecha_inicio, fecha_fin) {
            document.getElementById('my-edit-res-id').value = id;
            document.getElementById('my-edit-habitacion').value = id_habitacion;
            document.getElementById('my-edit-checkIn').value = new Date(fecha_inicio).toISOString().split('T')[0];
            document.getElementById('my-edit-checkOut').value = new Date(fecha_fin).toISOString().split('T')[0];
            document.getElementById('editMyReservationModal').classList.add('active');
        }

        function closeEditMyReservation() {
            document.getElementById('editMyReservationModal').classList.remove('active');
        }

        async function submitEditMyReservation(e) {
            e.preventDefault();
            const id = document.getElementById('my-edit-res-id').value;
            const id_habitacion = document.getElementById('my-edit-habitacion').value;
            const fecha_inicio = document.getElementById('my-edit-checkIn').value;
            const fecha_fin = document.getElementById('my-edit-checkOut').value;
            const msg = document.getElementById('my-edit-res-message');

            try {
                const resp = await fetch(`/reservas/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_habitacion, fecha_inicio, fecha_fin })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    alert('Reserva actualizada correctamente');
                    window.location.reload();
                } else {
                    msg.innerHTML = '<div class="error">' + (data.error || 'Error') + '</div>';
                }
            } catch (error) {
                console.error(error);
                msg.innerHTML = '<div class="error">Error al actualizar la reserva</div>';
            }
        }
    </script>
</body>

</html>
